# Transaction Execution and EVM Architecture

## The Journey of Ethereum Transactions: From Start to Finish

Welcome to one of the most fascinating aspects of Ethereum—transaction execution. In this module, we’ll unravel the step-by-step process that transitions Ethereum’s state to include your transaction. Imagine sending a transaction into the vast Ethereum network. What happens next? Let’s explore!

### The Entry Gate: Transaction Validity

![image.png](https://github.com/0xmetaschool/Learning-Projects/blob/main/assests_for_all/Mastering%20Ethereum%20From%20Blocks%20to%20Brilliance/2.%20The%20Ethereum%20Blockchain%20Paradigm/4.%20Transaction%20Execution%20and%20EVM%20Architecture/image.webp?raw=true)

Before a transaction even begins its journey through the Ethereum network, it must pass certain criteria to be deemed valid. Think of it as passing through a security checkpoint. Here’s the checklist:

1. **Properly Formatted RLP**: The transaction must use Recursive Length Prefix (RLP) encoding—a method Ethereum employs to serialize nested arrays of binary data. Without this, the transaction can’t even get started.
2. **Valid Transaction Signature**: This ensures the authenticity of the transaction, verifying that it was signed by the account’s private key.
3. **Correct Nonce**: The nonce must match the number of transactions previously sent from the sender’s account. For example, if Alice’s account has sent five transactions, her next transaction must have a nonce of six.
4. **Sufficient Gas Limit**: A transaction’s gas limit must at least cover its intrinsic gas cost, which is calculated as follows:

![image.png](https://github.com/0xmetaschool/Learning-Projects/blob/main/assests_for_all/Mastering%20Ethereum%20From%20Blocks%20to%20Brilliance/2.%20The%20Ethereum%20Blockchain%20Paradigm/4.%20Transaction%20Execution%20and%20EVM%20Architecture/image%201.webp?raw=true)

For contract-creating transactions, an additional 32,000 gas is required.

1. **Upfront Gas Costs**: The sender’s account balance must cover the total upfront gas cost, calculated as:

![image.png](https://github.com/0xmetaschool/Learning-Projects/blob/main/assests_for_all/Mastering%20Ethereum%20From%20Blocks%20to%20Brilliance/2.%20The%20Ethereum%20Blockchain%20Paradigm/4.%20Transaction%20Execution%20and%20EVM%20Architecture/image%202.webp?raw=true)

If all these conditions are met, the transaction is considered valid and proceeds to the next step.


### The Adventure Begins: Executing the Transaction

Once validated, the journey truly begins. Ethereum first deducts the upfront gas cost from the sender’s account balance and increments their nonce by one. The remaining gas is then calculated as:

![image.png](https://github.com/0xmetaschool/Learning-Projects/blob/main/assests_for_all/Mastering%20Ethereum%20From%20Blocks%20to%20Brilliance/2.%20The%20Ethereum%20Blockchain%20Paradigm/4.%20Transaction%20Execution%20and%20EVM%20Architecture/image%203.webp?raw=true)

With these preliminary adjustments made, the transaction dives into execution.

### The Substate: A Parallel Ledger

During execution, Ethereum maintains a “substate” to track temporary data:

- **Self-Destruct Set**: Accounts marked for deletion after the transaction ends.
- **Log Series**: A record of all events and logs triggered by the transaction.
- **Refund Balance**: Tracks gas refunds earned, such as those from clearing storage slots.

### The Execution Phase

The EVM (Ethereum Virtual Machine) executes the transaction’s instructions step by step, adjusting the system state as needed. Computation continues until one of three outcomes occurs:

![image.png](https://github.com/0xmetaschool/Learning-Projects/blob/main/assests_for_all/Mastering%20Ethereum%20From%20Blocks%20to%20Brilliance/2.%20The%20Ethereum%20Blockchain%20Paradigm/4.%20Transaction%20Execution%20and%20EVM%20Architecture/image%204.webp?raw=true)

1. **Exceptional Halt**: Errors like running out of gas, invalid opcodes, or stack overflows halt the execution, reverting all changes.
2. **Controlled Halt**: The execution completes successfully, updating the state and generating outputs.
3. **Out-of-Gas Exception**: The transaction runs out of gas, reverting changes but retaining spent gas fees.

### The Final Destination: Block Finalization

A transaction’s journey doesn’t end with execution. For the state changes to be recorded permanently, the containing block must be finalized. This involves:

1. **Transaction Validation**: Ensuring all transactions within the block are valid.
2. **Gas Accounting**: Verifying that the block’s total gas usage doesn’t exceed the block’s gas limit.
3. **Reward Distribution**: Miners receive rewards for block creation and valid ommers (uncle blocks).
4. **State Trie Update**: The final state is committed to Ethereum’s state trie.

## Contract Creation vs. Message Calls

| **Aspect** | **Contract Creation** | **Message Call** |
| --- | --- | --- |
| **Process** | Creates a new contract on the blockchain. | Interacts with an existing contract. |
| **Address Generation** | The contract’s address is generated based on the sender’s address and nonce. | No new address is generated. Calls are made to an existing contract address. |
| **Initialization** | Sets up contract’s storage, balance, and code. Initialization may fail due to out-of-gas, causing a revert. | No initialization required. The state remains unchanged unless the call succeeds. |
| **Storage Cost** | Gas cost depends on the size of the contract’s code. | No direct storage cost. Only data transfer and execution within the existing contract are affected. |
| **Gas Cost** | Higher gas cost due to the contract deployment process and storage setup. | Lower gas cost, as only the execution of functions or transactions is involved. |
| **Revert on Failure** | If the creation fails (e.g., due to out-of-gas), all changes revert, including the contract creation. | If the call fails, only the changes made by the call revert; the parent transaction remains unaffected. |
| **Impact on Blockchain** | Adds a new contract to the blockchain, expanding the contract set. | Does not add any new contracts. Interacts with an existing contract and executes its functions. |
| **State Changes** | Can modify the global state by creating a contract and updating the storage. | Can modify the state of the contract it interacts with, but doesn’t affect the global state outside of it. |

## A Day in the Life of a Transaction

Let’s imagine Alice sends 1 Ether to Bob, with a gas limit of 50,000 and a gas price of 20 Gwei. Here’s what happens:

1. **Validation**:
    - The transaction is encoded in RLP format.
    - The signature matches Alice’s private key.
    - The nonce matches Alice’s account state.
    - Intrinsic gas (21,000) is within the gas limit (50,000).
    - Upfront gas cost is deducted from Alice’s balance.
2. **Execution**:
    - The EVM processes instructions, transferring 1 Ether to Bob.
    - Remaining gas is refunded to Alice.
3. **Finalization**:
    - The transaction is included in a block.
    - The miner receives the gas fee in Ether.

By the end of this journey, Ethereum’s state reflects the transfer, and the transaction becomes an indelible part of the blockchain.

## Unpacking the Ethereum Virtual Machine (EVM)

### 1. History & Virtual Machines: The Epic Saga Begins

Before we dive into the technical jungle of the Ethereum Virtual Machine (EVM), let's rewind and set the stage. Our story begins with the rebellious peer-to-peer technology called **BitTorrent**. Imagine a world where you could share files without the need for centralized servers or middlemen—this is the spirit that laid the foundation for decentralized applications (dApps).

![image.png](https://github.com/0xmetaschool/Learning-Projects/blob/main/assests_for_all/Mastering%20Ethereum%20From%20Blocks%20to%20Brilliance/2.%20The%20Ethereum%20Blockchain%20Paradigm/4.%20Transaction%20Execution%20and%20EVM%20Architecture/image%205.webp?raw=true)

Then came **Vitalik Buterin**, the wizard who saw Bitcoin's power and thought, "What if I could program this blockchain thing to do more than just send money?" Alongside **Gavin Wood**, his sidekick, they birthed **Ethereum**—not just a cryptocurrency, but a **programmable blockchain** capable of executing code on a global scale. They created a blockchain that could not only store value but also **run decentralized programs**, aka smart contracts.

To understand this better, imagine the Ethereum ecosystem as a multi-layered cake (yum!):

- At the **bottom**: the hardware (the cake plate, if you will), the unsung heroes of the Ethereum network.
- Next up: the **virtual machine layer**, which is like the oven where all the magic happens.
- At the **top**: the **operating system** that keeps things running smooth. Ethereum has layers like a good cake, but instead of frosting, we’ve got a **decentralized global network**.


### 2. What is the EVM & Ethereum State? It's Like the Inner Workings of a Supercomputer

Now let’s talk about **Ethereum** and the all-powerful **Ethereum Virtual Machine (EVM)**. The EVM is like the brain of Ethereum. It’s the place where all the computations happen. But how does it fit into the Ethereum world?

Picture the Ethereum ecosystem as a giant sandwich:

![image.png](https://github.com/0xmetaschool/Learning-Projects/blob/main/assests_for_all/Mastering%20Ethereum%20From%20Blocks%20to%20Brilliance/2.%20The%20Ethereum%20Blockchain%20Paradigm/4.%20Transaction%20Execution%20and%20EVM%20Architecture/image%206.webp?raw=true)

- The **internet** : the bread that holds everything together.
- The **nodes** : these are like the slices of bread that hold the fillings, and each node in the Ethereum network helps process transactions.
- **EVM:** Think of the EVM as the **cheese** of this sandwich — the essential ingredient that makes everything come together and function properly.
- **Smart Contracts:** These are like the fillings — they contain the instructions for what should happen when a transaction is triggered.
- **dApps:** And at the top of the sandwich? The **dApps** — the apps you interact with every day, like decentralized Facebook or Twitter.

The EVM ensures that all this happens smoothly. It keeps track of **state** — the current status of accounts, balances, and contracts. It's like the Ethereum universe's central control system, maintaining the **world state** (global record of all accounts) and ensuring nothing goes wrong.


### 3. EVM Architecture: The Inner Mechanics – Like a Swiss Watch... But Cooler

Now, let’s get into the nitty-gritty details of how the EVM actually works. The EVM is like a **black box** of magic and mystery. But inside that box is some pretty awesome tech:

![image.png](https://github.com/0xmetaschool/Learning-Projects/blob/main/assests_for_all/Mastering%20Ethereum%20From%20Blocks%20to%20Brilliance/2.%20The%20Ethereum%20Blockchain%20Paradigm/4.%20Transaction%20Execution%20and%20EVM%20Architecture/image%207.webp?raw=true)

- **Program Counter**: This is the brain’s GPS. It keeps track of where the EVM is in the code. It’s like the map guiding the machine through its journey.
- **Gas Available**: Every time the EVM executes an operation, it spends a little **gas** (don’t worry, it’s not fuel for your car). Gas prevents infinite loops and ensures the system isn’t overwhelmed. Think of it like the calories you burn while coding—don't run out of gas!
- **Stack**: This is a **Last In, First Out (LIFO)** structure, meaning that the most recent data is processed first. It's like a messy desk — the top papers (data) are the first to be dealt with.
- **Memory**: Temporary storage used during contract execution. Once the contract finishes, it's wiped clean, like a whiteboard after a brainstorming session.
- **Viral ROM (Read-Only Memory)**: This is where the code itself sits. The code can’t be changed (it’s read-only), so no one can mess with it after it’s deployed. It’s like the **holy scripture** of the Ethereum network.
- **Account Storage**: This is like a **filing cabinet** where each Ethereum account’s data is permanently stored. The data stays there for eternity (or until you decide to change it).
- **World State & Machine State**: This is the "big picture" of the Ethereum world and its current status. World state is the global state of everything in Ethereum, and machine state is the current moment in the code’s execution. It’s like the difference between a **screenshot** and a **live video** of the network.

![image.png](https://github.com/0xmetaschool/Learning-Projects/blob/main/assests_for_all/Mastering%20Ethereum%20From%20Blocks%20to%20Brilliance/2.%20The%20Ethereum%20Blockchain%20Paradigm/4.%20Transaction%20Execution%20and%20EVM%20Architecture/image%208.webp?raw=true)

Together, these components work in harmony to execute transactions, store data, and keep everything moving forward.


### 4. Machine Space of the EVM: A Space Odyssey

In the EVM, we have three key places where the action happens:

![image.png](https://github.com/0xmetaschool/Learning-Projects/blob/main/assests_for_all/Mastering%20Ethereum%20From%20Blocks%20to%20Brilliance/2.%20The%20Ethereum%20Blockchain%20Paradigm/4.%20Transaction%20Execution%20and%20EVM%20Architecture/image%209.webp?raw=true)

- **Stack**: Think of it as the **workspace** of your contract. It’s temporary and always ready for quick calculations or function calls.
- **Memory**: This is where the contract keeps the data it needs **right now**. It's like a chalkboard you wipe clean once the lesson is over.
- **Account Storage**: This is the **permanent storage** — think of it as a vault where important info (like the balance of an account or the state of a smart contract) is safely stored forever.


### 5. EVM Opcodes, Bytecodes, ABI & Solidity: Code, Code, and More Code

Alright, let’s decode this madness (pun intended):

- **Solidity**: This is the programming language most developers use to write smart contracts. It's like the **toolkit** you need to create decentralized applications.

![image.png](https://github.com/0xmetaschool/Learning-Projects/blob/main/assests_for_all/Mastering%20Ethereum%20From%20Blocks%20to%20Brilliance/2.%20The%20Ethereum%20Blockchain%20Paradigm/4.%20Transaction%20Execution%20and%20EVM%20Architecture/image%2010.webp?raw=true)

- **Bytecode**: When you write your contract in Solidity, it gets compiled into bytecode. This bytecode is **machine-readable** and tells the EVM what to do.

![image.png](https://github.com/0xmetaschool/Learning-Projects/blob/main/assests_for_all/Mastering%20Ethereum%20From%20Blocks%20to%20Brilliance/2.%20The%20Ethereum%20Blockchain%20Paradigm/4.%20Transaction%20Execution%20and%20EVM%20Architecture/image%2011.webp?raw=true)

- **Opcodes**: These are the individual instructions that the EVM understands. They’re like the **basic commands** in a video game: move, jump, fire, etc.

![image.png](https://github.com/0xmetaschool/Learning-Projects/blob/main/assests_for_all/Mastering%20Ethereum%20From%20Blocks%20to%20Brilliance/2.%20The%20Ethereum%20Blockchain%20Paradigm/4.%20Transaction%20Execution%20and%20EVM%20Architecture/image%2012.webp?raw=true)

- **ABI (Application Binary Interface)**: The ABI is like the **remote control** for your contract. It defines how the outside world interacts with your contract, telling the EVM how to **encode and decode** data when calling functions.

Without these tools, your Ethereum adventure would be like trying to play chess without knowing how the pieces move. It's a lot of rules, but once you understand them, it becomes much more fun.


### 6. Understanding Your Code at the Lower Level: What’s Going On in the Engine?

![image.png](https://github.com/0xmetaschool/Learning-Projects/blob/main/assests_for_all/Mastering%20Ethereum%20From%20Blocks%20to%20Brilliance/2.%20The%20Ethereum%20Blockchain%20Paradigm/4.%20Transaction%20Execution%20and%20EVM%20Architecture/5dc7f125-c2b9-4e3b-ab2b-35614cfe513e.webp?raw=true)

If you really want to level up as a developer, you need to peek **under the hood**. When you deploy a smart contract, it’s like sending a **tiny robot** into the Ethereum network. This robot follows your code step-by-step, executing actions and interacting with other smart contracts. Understanding how the EVM executes your bytecode is like knowing exactly how a magician performs their tricks — it gives you the power to write cleaner, more efficient code.

### 7. How the EVM Works: The Ultimate Power-Up

When you hit “send” on an Ethereum transaction, here’s what happens:

1. Your transaction gets broadcast to the network, and the **Ethereum nodes** get to work.
2. The **EVM** checks if everything is in order. Are the funds there? Is the transaction valid? Is there enough gas? It’s like a bouncer checking IDs at a club.
3. Once validated, the transaction is executed, updating the **Ethereum state** (like changing an account balance or executing a smart contract).
4. Finally, the transaction gets recorded on the blockchain. **Boom!** It’s immutable and can never be changed.

### 8. Turing Completeness: The Secret Superpower

Here’s where things get really cool. The **EVM** is **Turing-complete**. In plain English, this means the EVM can **solve any problem** that can be turned into an algorithm (as long as it has enough gas). It’s like having a **superpower** that can solve any riddle or computation, given the right conditions.

- A Turing Machine is like the **ultimate math brain**. It can perform any computation, process infinite data (if resources allow), and can loop or recurse to solve even the most complex problems.

So when people say Ethereum is **Turing-complete**, they’re basically saying that it’s like a **world-class supercomputer**. You can do anything with it — provided you’re careful not to run out of gas (or patience).

### In Conclusion

Understanding the Ethereum Virtual Machine is like mastering a video game. At first, all the technical terms and concepts might seem overwhelming, but once you know how the EVM works, you'll be able to create decentralized applications like a true blockchain wizard. So, grab your code, summon some smart contracts, and get ready to power-up your Ethereum journey!